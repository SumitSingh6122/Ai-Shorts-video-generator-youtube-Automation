name: Video Production Pipeline

on:
  workflow_dispatch:
    inputs:
      audioURL:
        description: 'URL of the audio file'
        required: true
      captionJson:
        description: 'JSON array of captions'
        required: true
      imageJson:
        description: 'JSON array of image URLs'
        required: true
      caption_Style:
        description: 'JSON of text styling (as string)'
        required: true
      videoId:
        description: 'ID of the video record in Convex'
        required: true

jobs:
  render-and-upload:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - run: npm ci --legacy-peer-deps

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Prepare Input Data
        run: |
          jq -n \
          --arg audioURL "https://res.cloudinary.com/dk75dh0nv/video/upload/v1746086474/generated_audio/audio_1746086474345.mp3" \
          --argjson captionJson '[{"confidence":0.99847907,"end":0.32,"start":0,"word":"once"},{"confidence":0.998914,"end":0.64,"start":0.32,"word":"upon"},{"confidence":0.99977213,"end":0.79999995,"start":0.64,"word":"a"},{"confidence":0.99996984,"end":0.96,"start":0.79999995,"word":"time"},{"confidence":0.5619838,"end":1.28,"start":0.96,"word":"in"},{"confidence":0.99954104,"end":1.4399999,"start":1.28,"word":"a"},{"confidence":0.9998708,"end":1.68,"start":1.4399999,"word":"land"},{"confidence":0.9989303,"end":2.08,"start":1.68,"word":"filled"},{"confidence":0.9998958,"end":2.24,"start":2.08,"word":"with"},{"confidence":0.9998791,"end":2.72,"start":2.24,"word":"colorful"},{"confidence":0.9997553,"end":3.12,"start":2.72,"word":"trees"},{"confidence":0.9968964,"end":3.36,"start":3.12,"word":"and"},{"confidence":0.99975115,"end":3.9199998,"start":3.36,"word":"sparkling"},{"confidence":0.8801982,"end":4.56,"start":3.9199998,"word":"rivers"},{"confidence":0.9979242,"end":5.2,"start":4.88,"word":"lived"},{"confidence":0.99969757,"end":5.3599997,"start":5.2,"word":"a"},{"confidence":0.9999099,"end":5.52,"start":5.3599997,"word":"little"},{"confidence":0.9989013,"end":5.92,"start":5.52,"word":"bunny"},{"confidence":0.9987993,"end":6.24,"start":5.92,"word":"named"},{"confidence":0.986924,"end":7.04,"start":6.24,"word":"benny"},{"confidence":0.9987039,"end":7.68,"start":7.2799997,"word":"benny"},{"confidence":0.9987363,"end":8,"start":7.68,"word":"loved"},{"confidence":0.99860954,"end":8.4,"start":8,"word":"carrots"},{"confidence":0.99972016,"end":8.639999,"start":8.4,"word":"more"},{"confidence":0.9999709,"end":8.8,"start":8.639999,"word":"than"},{"confidence":0.99980897,"end":9.44,"start":8.8,"word":"anything"},{"confidence":0.99969935,"end":10,"start":9.76,"word":"one"},{"confidence":0.9623605,"end":10.4,"start":10,"word":"day"},{"confidence":0.99927104,"end":10.639999,"start":10.4,"word":"benny"},{"confidence":0.9997595,"end":10.88,"start":10.639999,"word":"found"},{"confidence":0.999258,"end":11.04,"start":10.88,"word":"a"},{"confidence":0.9998235,"end":11.44,"start":11.04,"word":"giant"},{"confidence":0.9996117,"end":11.92,"start":11.44,"word":"carrot"},{"confidence":0.76254785,"end":12.24,"start":11.92,"word":"bigger"},{"confidence":0.99988735,"end":12.48,"start":12.24,"word":"than"},{"confidence":0.99966204,"end":13.119999,"start":12.48,"word":"himself"},{"confidence":0.9998995,"end":13.679999,"start":13.44,"word":"he"},{"confidence":0.99988496,"end":13.84,"start":13.679999,"word":"tried"},{"confidence":0.9999101,"end":14,"start":13.84,"word":"to"},{"confidence":0.99991834,"end":14.16,"start":14,"word":"pull"},{"confidence":0.9070423,"end":14.4,"start":14.16,"word":"it"},{"confidence":0.99996555,"end":14.48,"start":14.4,"word":"but"},{"confidence":0.9999267,"end":14.639999,"start":14.48,"word":"it"},{"confidence":0.9999495,"end":14.88,"start":14.639999,"word":"wouldn'\''t"},{"confidence":0.99987936,"end":15.28,"start":14.88,"word":"budge"},{"confidence":0.99991167,"end":15.965,"start":15.645,"word":"he"},{"confidence":0.99987864,"end":16.205,"start":15.965,"word":"asked"},{"confidence":0.9995679,"end":16.365,"start":16.205,"word":"his"},{"confidence":0.9999275,"end":16.605,"start":16.365,"word":"friend"},{"confidence":0.51769626,"end":17.005001,"start":16.605,"word":"freddie"},{"confidence":0.92851996,"end":17.165,"start":17.005001,"word":"the"},{"confidence":0.56945896,"end":17.485,"start":17.165,"word":"fox"},{"confidence":0.9869811,"end":17.725,"start":17.485,"word":"for"},{"confidence":0.9988632,"end":18.285,"start":17.725,"word":"help"},{"confidence":0.9913332,"end":18.845001,"start":18.525,"word":"freddie"},{"confidence":0.901602,"end":19.485,"start":18.845001,"word":"pulled"},{"confidence":0.9999609,"end":19.565,"start":19.485,"word":"but"},{"confidence":0.99935323,"end":19.885,"start":19.565,"word":"still"},{"confidence":0.998129,"end":20.525,"start":19.885,"word":"nothing"},{"confidence":0.9996612,"end":21.085001,"start":20.845001,"word":"they"},{"confidence":0.99961853,"end":21.245,"start":21.085001,"word":"then"},{"confidence":0.9968651,"end":21.485,"start":21.245,"word":"asked"},{"confidence":0.98930174,"end":21.885,"start":21.485,"word":"rosie"},{"confidence":0.97843766,"end":22.045,"start":21.885,"word":"the"},{"confidence":0.9638243,"end":22.845,"start":22.045,"word":"raccoon"},{"confidence":0.96677846,"end":23.725,"start":23.005001,"word":"together"},{"confidence":0.99978405,"end":23.885,"start":23.725,"word":"they"},{"confidence":0.99960774,"end":24.285,"start":23.885,"word":"pulled"},{"confidence":0.99368346,"end":24.605,"start":24.285,"word":"and"},{"confidence":0.9959042,"end":24.925,"start":24.605,"word":"pulled"},{"confidence":0.99970657,"end":25.736,"start":25.496,"word":"with"},{"confidence":0.99768126,"end":25.896,"start":25.736,"word":"a"},{"confidence":0.9999435,"end":26.216,"start":25.896,"word":"final"},{"confidence":0.9985973,"end":26.776001,"start":26.216,"word":"tug"},{"confidence":0.99939144,"end":26.936,"start":26.776001,"word":"the"},{"confidence":0.9965275,"end":27.256,"start":26.936,"word":"giant"},{"confidence":0.9969351,"end":27.656,"start":27.256,"word":"carrot"},{"confidence":0.99935585,"end":28.056,"start":27.656,"word":"popped"},{"confidence":0.99986947,"end":28.216,"start":28.056,"word":"out"},{"confidence":0.99973446,"end":28.296,"start":28.216,"word":"of"},{"confidence":0.99992526,"end":28.456001,"start":28.296,"word":"the"},{"confidence":0.99895364,"end":29.016,"start":28.456001,"word":"ground"},{"confidence":0.9770902,"end":29.816,"start":29.256,"word":"benny"},{"confidence":0.8935796,"end":30.136,"start":29.816,"word":"freddie"},{"confidence":0.99987054,"end":30.216,"start":30.136,"word":"and"},{"confidence":0.9788159,"end":30.536,"start":30.216,"word":"rosie"},{"confidence":0.9991128,"end":30.856,"start":30.536,"word":"shared"},{"confidence":0.9998375,"end":31.016,"start":30.856,"word":"the"},{"confidence":0.9995913,"end":31.336,"start":31.016,"word":"giant"},{"confidence":0.96364135,"end":31.976,"start":31.336,"word":"carrot"},{"confidence":0.9995552,"end":32.536,"start":32.056,"word":"realizing"},{"confidence":0.9999074,"end":32.856,"start":32.536,"word":"that"},{"confidence":0.999835,"end":33.096,"start":32.856,"word":"even"},{"confidence":0.9999229,"end":33.256,"start":33.096,"word":"the"},{"confidence":0.9999422,"end":33.576,"start":33.256,"word":"biggest"},{"confidence":0.99992955,"end":34.056,"start":33.576,"word":"challenges"},{"confidence":0.9999405,"end":34.296,"start":34.056,"word":"are"},{"confidence":0.9999504,"end":34.696,"start":34.296,"word":"easier"},{"confidence":0.99995005,"end":34.856,"start":34.696,"word":"with"},{"confidence":0.9988817,"end":35.256,"start":34.856,"word":"friends"}]' \
          --argjson imageJson '["https://firebasestorage.googleapis.com/v0/b/projects-2025-71366.firebasestorage.app/o/ai-guru-lab-images%2F1746086515589.png?alt=media&token=341257e7-d702-455a-8a5a-df9e1949d774","https://firebasestorage.googleapis.com/v0/b/projects-2025-71366.firebasestorage.app/o/ai-guru-lab-images%2F1746086515460.png?alt=media&token=442f2f5c-4972-4084-835d-cece1d1dea1c","https://firebasestorage.googleapis.com/v0/b/projects-2025-71366.firebasestorage.app/o/ai-guru-lab-images%2F1746086515870.png?alt=media&token=b44642e9-d95c-4c54-9f1d-d565f37aa5e4","https://firebasestorage.googleapis.com/v0/b/projects-2025-71366.firebasestorage.app/o/ai-guru-lab-images%2F1746086515574.png?alt=media&token=f69b669e-d7a0-4d51-8b52-2d4ed202f2ab","https://firebasestorage.googleapis.com/v0/b/projects-2025-71366.firebasestorage.app/o/ai-guru-lab-images%2F1746086515756.png?alt=media&token=dff97d31-4dbb-4757-a413-40584356e515"]' \
          --arg caption_Style "youtuber" \
          '{
              videoData: {
              audioURL: $audioURL,
              captionJson: $captionJson,
              image: $imageJson,
              caption_Style: $caption_Style
              }
              }' > input-props.json

      
      - name: Render Video
        run: npx remotion render remotion/index.ts MyVideo out/video.mp4 --props=./input-props.json

      - name: Verify Render Output
        run: |
          if [ ! -f out/video.mp4 ]; then
            echo "❌ Render failed: No output file found"
            exit 1
          fi
          echo "✅ Render successful - File size: $(du -h out/video.mp4 | cut -f1)"
      - name: Upload to Cloudinary
        env:
          CLOUDINARY_CLOUD_NAME: dk75dh0nv
          CLOUDINARY_API_KEY: 475864168871595
          CLOUDINARY_API_SECRET: -CkPLllqq-nfCMVMMeRI1Z_SAwg
        run: |
          npm install cloudinary --legacy-peer-deps
          node -e "
          const cloudinary = require('cloudinary').v2;
          cloudinary.config({
            cloud_name: process.env.CLOUDINARY_CLOUD_NAME,
            api_key: process.env.CLOUDINARY_API_KEY,
            api_secret: process.env.CLOUDINARY_API_SECRET
          });
          cloudinary.uploader.upload('out/video.mp4', { resource_type: 'video', folder: 'renders', overwrite: true }, (error, result) => {
            if (error) {
              console.error('❌ Cloudinary upload failed:', error);
              process.exit(1);
            }
            console.log('✅ Cloudinary upload successful:', result.secure_url);
            require('fs').writeFileSync('cloudinary-response.json', JSON.stringify(result));
          });
          "
      - name: Set Output
        run: |
          VIDEO_URL=$(jq -r .secure_url cloudinary-response.json)
          echo "video_url=$VIDEO_URL" >> $GITHUB_OUTPUT
      - name: Notify Frontend
        run: |
          VIDEO_URL=$(jq -r .secure_url cloudinary-response.json)
          curl -X POST "https://ai-shorts-video-gen.vercel.app/api/webhook" \
            -H "Content-Type: application/json" \
            -d "{\"video_url\": \"$VIDEO_URL\", \"videoId\": \"${{ inputs.videoId }}\"}"