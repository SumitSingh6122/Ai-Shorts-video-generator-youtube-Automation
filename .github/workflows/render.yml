# .github/workflows/video-production-pipeline.yml
name: Video Production Pipeline

on:
  workflow_dispatch:
    inputs:
      audioURL:
        description: 'URL of the audio file'
        required: true
      captionJson:
        description: 'JSON array of captions'
        required: true
      imageJson:
        description: 'JSON array of image URLs'
        required: true
      CaptionStyle:
        description: 'JSON of text styling'
        required: true

env:
  CUSTOM_API_ENDPOINT: 'http://localhost:3000/testing/api/upload' 

jobs:
  render-and-upload:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - run: npm ci

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Prepare Input Data
        run: |
          echo '${{ toJson(github.event.inputs) }}' > inputs.json
          jq '{
            videoData: {
              audioURL: .audioURL,
              captionJson: (.captionJson | fromjson),
              image: (.imageJson | fromjson),
              CaptionStyle: (.CaptionStyle | fromjson)
            }
          }' inputs.json > input-props.json

      - name: Render Video
        run: npx remotion render remotion/index.ts MyVideo out/video.mp4 --props=./input-props.json

      - name: Verify Render Output
        run: |
          if [ ! -f out/video.mp4 ]; then
            echo "❌ Render failed: No output file found"
            exit 1
          fi
          echo "✅ Render successful - File size: $(du -h out/video.mp4 | cut -f1)"

      - name: Send Video to API
        run: |
          curl -X POST "$CUSTOM_API_ENDPOINT" \
            -H "Content-Type: multipart/form-data" \
            -F "video=@out/video.mp4" \
            -F "metadata=$(jq -c . < input-props.json)" \
            -o api-response.json

          if [ $? -ne 0 ]; then
            echo "❌ API upload failed"
            exit 1
          fi

      - name: Log API Response
        run: |
          echo "✅ API Response:"
          cat api-response.json
