name: Video Production Pipeline

on:
  workflow_dispatch:
    inputs:
      audioURL:
        description: 'URL of the audio file'
        required: true
      captionJson:
        description: 'JSON array of captions'
        required: true
      imageJson:
        description: 'JSON array of image URLs'
        required: true
      caption_Style:
        description: 'JSON of text styling (as string)'
        required: true
      videoId:
        description: 'ID of the video record in Convex'
        required: true

jobs:
  render-and-upload:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - run: npm ci --legacy-peer-deps

      - name: Install jq
        run: sudo apt-get install -y jq
      
      - name: Prepare Input Data
        run: |
          jq -n \
          --arg audioURL "${{ github.event.inputs.audioURL }}" \
          --arg caption_Style "youtuber" \
          --arg captionJson '[{"confidence":0.99923074,"end":0.39999998,"start":0,"word":"long"},{"confidence":0.9692666,"end":0.96,"start":0.39999998,"word":"ago"},{"confidence":0.99977463,"end":1.12,"start":0.96,"word":"in"},{"confidence":0.99956745,"end":1.28,"start":1.12,"word":"a"},{"confidence":0.9970107,"end":1.5999999,"start":1.28,"word":"kingdom"},{"confidence":0.99940526,"end":2.08,"start":1.5999999,"word":"shadowed"},{"confidence":0.9999645,"end":2.24,"start":2.08,"word":"by"},{"confidence":0.9998005,"end":2.6399999,"start":2.24,"word":"ancient"},{"confidence":0.9767906,"end":3.5199997,"start":2.6399999,"word":"forests"},{"confidence":0.9992913,"end":3.84,"start":3.6,"word":"lived"},{"confidence":0.9982514,"end":4,"start":3.84,"word":"a"},{"confidence":0.9992901,"end":4.48,"start":4,"word":"princess"},{"confidence":0.9983296,"end":5.04,"start":4.48,"word":"destined"},{"confidence":0.99997616,"end":5.2,"start":5.04,"word":"for"},{"confidence":0.9998995,"end":5.3599997,"start":5.2,"word":"a"},{"confidence":0.999668,"end":5.6,"start":5.3599997,"word":"throne"},{"confidence":0.9990427,"end":5.92,"start":5.6,"word":"she"},{"confidence":0.999933,"end":6.16,"start":5.92,"word":"never"},{"confidence":0.94179505,"end":6.88,"start":6.16,"word":"desired"},{"confidence":0.99970776,"end":7.44,"start":7.2799997,"word":"a"},{"confidence":0.99973667,"end":7.9199996,"start":7.44,"word":"prophecy"},{"confidence":0.9987691,"end":8.4,"start":7.9199996,"word":"foretold"},{"confidence":0.99812394,"end":8.639999,"start":8.4,"word":"her"},{"confidence":0.9957209,"end":8.88,"start":8.639999,"word":"reign"},{"confidence":0.99989104,"end":9.12,"start":8.88,"word":"would"},{"confidence":0.9999151,"end":9.44,"start":9.12,"word":"bring"},{"confidence":0.9990031,"end":9.84,"start":9.44,"word":"either"},{"confidence":0.99943596,"end":10.559999,"start":9.84,"word":"unparalleled"},{"confidence":0.9998994,"end":11.36,"start":10.559999,"word":"prosperity"},{"confidence":0.99046725,"end":11.759999,"start":11.36,"word":"or"},{"confidence":0.99837613,"end":12.08,"start":11.759999,"word":"utter"},{"confidence":0.9898627,"end":12.48,"start":12.08,"word":"ruin"},{"confidence":0.9985013,"end":13.565001,"start":13.165,"word":"torn"},{"confidence":0.999967,"end":13.885,"start":13.565001,"word":"between"},{"confidence":0.9994667,"end":14.205,"start":13.885,"word":"duty"},{"confidence":0.9979741,"end":14.365,"start":14.205,"word":"and"},{"confidence":0.99974483,"end":14.525,"start":14.365,"word":"her"},{"confidence":0.9997982,"end":14.845,"start":14.525,"word":"yearning"},{"confidence":0.99993753,"end":15.005,"start":14.845,"word":"for"},{"confidence":0.99946743,"end":15.165,"start":15.005,"word":"a"},{"confidence":0.9997737,"end":15.405,"start":15.165,"word":"life"},{"confidence":0.99982005,"end":15.725,"start":15.405,"word":"beyond"},{"confidence":0.9999007,"end":15.885,"start":15.725,"word":"the"},{"confidence":0.9994973,"end":16.205,"start":15.885,"word":"castle"},{"confidence":0.9944641,"end":16.925,"start":16.205,"word":"walls"},{"confidence":0.9996145,"end":17.085,"start":16.925,"word":"she"},{"confidence":0.99985623,"end":17.485,"start":17.085,"word":"embarked"},{"confidence":0.999964,"end":17.725,"start":17.485,"word":"on"},{"confidence":0.9998492,"end":17.885,"start":17.725,"word":"a"},{"confidence":0.9997874,"end":18.365,"start":17.885,"word":"perilous"},{"confidence":0.9995092,"end":19.005,"start":18.365,"word":"quest"},{"confidence":0.9999156,"end":19.565,"start":19.325,"word":"she"},{"confidence":0.99949634,"end":19.885,"start":19.565,"word":"sought"},{"confidence":0.99980193,"end":20.045,"start":19.885,"word":"the"},{"confidence":0.99992955,"end":20.525,"start":20.045,"word":"wisdom"},{"confidence":0.9999454,"end":20.685,"start":20.525,"word":"of"},{"confidence":0.9998332,"end":20.765,"start":20.685,"word":"a"},{"confidence":0.99970543,"end":21.244999,"start":20.765,"word":"reclusive"},{"confidence":0.93569523,"end":22.045,"start":21.244999,"word":"hermit"},{"confidence":0.9981818,"end":22.285,"start":22.045,"word":"said"},{"confidence":0.9993781,"end":22.445,"start":22.285,"word":"to"},{"confidence":0.99920875,"end":22.845001,"start":22.445,"word":"possess"},{"confidence":0.9997594,"end":23.005001,"start":22.845001,"word":"the"},{"confidence":0.9998536,"end":23.404999,"start":23.005001,"word":"secrets"},{"confidence":0.99994755,"end":23.564999,"start":23.404999,"word":"of"},{"confidence":0.9998697,"end":23.724998,"start":23.564999,"word":"the"},{"confidence":0.9942031,"end":24.205,"start":23.724998,"word":"kingdom'\''s"},{"confidence":0.99660826,"end":24.765,"start":24.205,"word":"fate"},{"confidence":0.9998124,"end":25.404999,"start":25.085,"word":"along"},{"confidence":0.99987257,"end":25.564999,"start":25.404999,"word":"the"},{"confidence":0.97122324,"end":25.965,"start":25.564999,"word":"way"},{"confidence":0.999946,"end":26.045,"start":25.965,"word":"she"},{"confidence":0.99978393,"end":26.365,"start":26.045,"word":"faced"},{"confidence":0.99992454,"end":26.845001,"start":26.365,"word":"mythical"},{"confidence":0.99962616,"end":27.404999,"start":26.845001,"word":"beasts"},{"confidence":0.9977112,"end":27.564999,"start":27.404999,"word":"and"},{"confidence":0.9999135,"end":28.125,"start":27.564999,"word":"treacherous"},{"confidence":0.9516759,"end":28.765,"start":28.125,"word":"landscapes"},{"confidence":0.9972115,"end":29.3,"start":29.06,"word":"her"},{"confidence":0.9997756,"end":29.699999,"start":29.3,"word":"courage"},{"confidence":0.99965394,"end":30.18,"start":29.699999,"word":"tested"},{"confidence":0.99985874,"end":30.5,"start":30.18,"word":"at"},{"confidence":0.99994564,"end":30.82,"start":30.5,"word":"every"},{"confidence":0.9994117,"end":31.46,"start":30.82,"word":"turn"},{"confidence":0.99979895,"end":32.02,"start":31.779999,"word":"in"},{"confidence":0.99997556,"end":32.18,"start":32.02,"word":"the"},{"confidence":0.9989274,"end":32.739998,"start":32.18,"word":"end"},{"confidence":0.9991561,"end":33.059998,"start":32.82,"word":"she"},{"confidence":0.99991953,"end":33.62,"start":33.059998,"word":"discovered"},{"confidence":0.9999404,"end":33.86,"start":33.62,"word":"that"},{"confidence":0.99991715,"end":34.02,"start":33.86,"word":"the"},{"confidence":0.99966407,"end":34.26,"start":34.02,"word":"true"},{"confidence":0.9999459,"end":34.579998,"start":34.26,"word":"power"},{"confidence":0.9999273,"end":34.739998,"start":34.579998,"word":"to"},{"confidence":0.999629,"end":34.98,"start":34.739998,"word":"shape"},{"confidence":0.9998498,"end":35.22,"start":34.98,"word":"her"},{"confidence":0.99983656,"end":35.86,"start":35.22,"word":"destiny"},{"confidence":0.649894,"end":36.18,"start":35.86,"word":"and"},{"confidence":0.9999056,"end":36.34,"start":36.18,"word":"the"},{"confidence":0.95107,"end":37.059998,"start":36.34,"word":"kingdoms"},{"confidence":0.73486173,"end":37.46,"start":37.059998,"word":"lay"},{"confidence":0.98866326,"end":37.7,"start":37.46,"word":"not"},{"confidence":0.99985504,"end":37.86,"start":37.7,"word":"in"},{"confidence":0.8818509,"end":38.739998,"start":37.86,"word":"prophecy"},{"confidence":0.9998927,"end":38.82,"start":38.739998,"word":"but"},{"confidence":0.9999461,"end":38.98,"start":38.82,"word":"in"},{"confidence":0.99992526,"end":39.22,"start":38.98,"word":"her"},{"confidence":0.99992645,"end":39.46,"start":39.22,"word":"own"},{"confidence":0.9982107,"end":39.94,"start":39.46,"word":"choices"}]' \
          --arg imageJson '${{ github.event.inputs.imageJson }}' \
          '{
          videoData: {
          audioURL: $audioURL,
          captionJson: ($captionJson | fromjson),
          image: ($imageJson | fromjson),
          caption_Style: $caption_Style
          }
           }' > input-props.json
      
      - name: Render Video
        run: npx remotion render remotion/index.ts MyVideo out/video.mp4 --props=./input-props.json

      - name: Verify Render Output
        run: |
          if [ ! -f out/video.mp4 ]; then
            echo "❌ Render failed: No output file found"
            exit 1
          fi
          echo "✅ Render successful - File size: $(du -h out/video.mp4 | cut -f1)"

      - name: Upload to Cloudinary
        env:
          CLOUDINARY_CLOUD_NAME: dk75dh0nv
          CLOUDINARY_API_KEY: 475864168871595
          CLOUDINARY_API_SECRET: -CkPLllqq-nfCMVMMeRI1Z_SAwg
        run: |
          npm install cloudinary --legacy-peer-deps
          node -e "
            const cloudinary = require('cloudinary').v2;
            const fs = require('fs');
            cloudinary.config({
              cloud_name: process.env.CLOUDINARY_CLOUD_NAME,
              api_key: process.env.CLOUDINARY_API_KEY,
              api_secret: process.env.CLOUDINARY_API_SECRET
            });
            cloudinary.uploader.upload('out/video.mp4', {
              resource_type: 'video',
              folder: 'renders',
              overwrite: true
            }, (error, result) => {
              if (error) {
                console.error('❌ Cloudinary upload failed:', error);
                process.exit(1);
              }
              console.log('✅ Cloudinary upload successful:', result.secure_url);
              fs.writeFileSync('cloudinary-response.json', JSON.stringify(result));
            });
          "

      - name: Set Output
        id: set_output
        run: |
          VIDEO_URL=$(jq -r .secure_url cloudinary-response.json)
          echo "video_url=$VIDEO_URL"
          echo "video_url=$VIDEO_URL" >> $GITHUB_OUTPUT

      - name: Notify Frontend
        run: |
          VIDEO_URL=$(jq -r .secure_url cloudinary-response.json)
          curl -X POST "https://ai-shorts-video-gen.vercel.app/api/webhook" \
            -H "Content-Type: application/json" \
            -d "{\"video_url\": \"$VIDEO_URL\", \"videoId\": \"${{ github.event.inputs.videoId }}\"}"
